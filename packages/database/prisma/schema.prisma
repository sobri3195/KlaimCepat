// Prisma Schema for Expense Claims System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============= User Management =============

enum UserRole {
  EMPLOYEE
  MANAGER
  FINANCE
  ADMIN
  CFO
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id                String      @id @default(uuid())
  email             String      @unique
  password          String
  firstName         String
  lastName          String
  phoneNumber       String?
  employeeId        String      @unique
  role              UserRole    @default(EMPLOYEE)
  status            UserStatus  @default(ACTIVE)
  departmentId      String?
  department        Department? @relation(fields: [departmentId], references: [id])
  managerId         String?
  manager           User?       @relation("ManagerSubordinates", fields: [managerId], references: [id])
  subordinates      User[]      @relation("ManagerSubordinates")
  position          String?
  
  // Relations
  claims            Claim[]
  approvals         Approval[]
  tripRequests      TripRequest[]
  notifications     Notification[]
  budgetAllocations BudgetAllocation[]
  auditLogs         AuditLog[]
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@index([departmentId])
  @@index([managerId])
  @@index([email])
}

model Department {
  id               String             @id @default(uuid())
  name             String             @unique
  code             String             @unique
  description      String?
  managerId        String?
  users            User[]
  claims           Claim[]
  budgets          Budget[]
  approvalPolicies ApprovalPolicy[]
  
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
}

// ============= Expense Claims =============

enum ClaimStatus {
  DRAFT
  SUBMITTED
  PENDING_APPROVAL
  APPROVED
  REJECTED
  PAID
  CANCELLED
}

enum ClaimType {
  TRAVEL
  MEAL
  ACCOMMODATION
  TRANSPORTATION
  ENTERTAINMENT
  EQUIPMENT
  OTHER
}

model Claim {
  id                String         @id @default(uuid())
  claimNumber       String         @unique
  userId            String
  user              User           @relation(fields: [userId], references: [id])
  departmentId      String?
  department        Department?    @relation(fields: [departmentId], references: [id])
  projectId         String?
  project           Project?       @relation(fields: [projectId], references: [id])
  tripRequestId     String?        @unique
  tripRequest       TripRequest?   @relation(fields: [tripRequestId], references: [id])
  
  title             String
  description       String?
  claimType         ClaimType
  totalAmount       Decimal        @db.Decimal(15, 2)
  currency          String         @default("IDR")
  exchangeRate      Decimal?       @db.Decimal(10, 4)
  convertedAmount   Decimal?       @db.Decimal(15, 2)
  
  status            ClaimStatus    @default(DRAFT)
  submittedAt       DateTime?
  
  // Policy compliance
  policyViolations  PolicyViolation[]
  hasViolations     Boolean        @default(false)
  
  // Approval workflow
  approvals         Approval[]
  currentApprovalLevel Int         @default(0)
  
  // Payment
  paymentDate       DateTime?
  paymentReference  String?
  payrollBatchId    String?
  payrollBatch      PayrollBatch?  @relation(fields: [payrollBatchId], references: [id])
  
  // Line items
  items             ClaimItem[]
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([departmentId])
  @@index([projectId])
  @@index([claimNumber])
}

model ClaimItem {
  id                String          @id @default(uuid())
  claimId           String
  claim             Claim           @relation(fields: [claimId], references: [id], onDelete: Cascade)
  
  date              DateTime
  category          String
  description       String
  amount            Decimal         @db.Decimal(15, 2)
  currency          String          @default("IDR")
  vendor            String?
  
  // Receipt/Invoice details
  receiptUrl        String?
  receiptFileName   String?
  receiptFileSize   Int?
  receiptMimeType   String?
  
  // OCR data
  ocrData           Json?
  ocrConfidence     Decimal?        @db.Decimal(5, 2)
  ocrProcessedAt    DateTime?
  isOcrVerified     Boolean         @default(false)
  
  // Tax
  taxAmount         Decimal?        @db.Decimal(15, 2)
  taxRate           Decimal?        @db.Decimal(5, 2)
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([claimId])
}

// ============= Approval Workflow =============

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  ESCALATED
}

model Approval {
  id              String          @id @default(uuid())
  claimId         String
  claim           Claim           @relation(fields: [claimId], references: [id], onDelete: Cascade)
  approverId      String
  approver        User            @relation(fields: [approverId], references: [id])
  
  level           Int
  status          ApprovalStatus  @default(PENDING)
  comments        String?
  approvedAt      DateTime?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@unique([claimId, level])
  @@index([claimId])
  @@index([approverId])
  @@index([status])
}

model ApprovalPolicy {
  id              String       @id @default(uuid())
  name            String
  description     String?
  
  // Conditions
  departmentId    String?
  department      Department?  @relation(fields: [departmentId], references: [id])
  claimTypes      ClaimType[]
  minAmount       Decimal?     @db.Decimal(15, 2)
  maxAmount       Decimal?     @db.Decimal(15, 2)
  
  // Approval levels
  approvalLevels  Json         // Array of approval level definitions
  
  isActive        Boolean      @default(true)
  priority        Int          @default(0)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([departmentId])
}

// ============= Policy Compliance =============

enum ViolationType {
  AMOUNT_EXCEEDED
  UNAUTHORIZED_CATEGORY
  MISSING_RECEIPT
  DUPLICATE_CLAIM
  POLICY_BREACH
  OTHER
}

model PolicyViolation {
  id              String         @id @default(uuid())
  claimId         String
  claim           Claim          @relation(fields: [claimId], references: [id], onDelete: Cascade)
  
  type            ViolationType
  severity        String         // LOW, MEDIUM, HIGH, CRITICAL
  message         String
  policyRule      String?
  
  isWaived        Boolean        @default(false)
  waivedBy        String?
  waivedReason    String?
  waivedAt        DateTime?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@index([claimId])
}

model CompanyPolicy {
  id              String       @id @default(uuid())
  name            String
  category        String
  description     String
  
  // Policy rules (JSON structure)
  rules           Json
  
  isActive        Boolean      @default(true)
  effectiveFrom   DateTime     @default(now())
  effectiveTo     DateTime?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

// ============= Trip Management =============

enum TripStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model TripRequest {
  id              String       @id @default(uuid())
  tripNumber      String       @unique
  userId          String
  user            User         @relation(fields: [userId], references: [id])
  
  title           String
  purpose         String
  destination     String
  departureDate   DateTime
  returnDate      DateTime
  
  status          TripStatus   @default(DRAFT)
  
  // Estimated costs
  estimatedCost   Decimal      @db.Decimal(15, 2)
  currency        String       @default("IDR")
  
  // Travel details
  transportMode   String?      // FLIGHT, TRAIN, CAR, BUS
  accommodation   String?
  
  // Advance payment
  advanceAmount   Decimal?     @db.Decimal(15, 2)
  advancePaid     Boolean      @default(false)
  
  // Associated claim
  claim           Claim?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([userId])
  @@index([status])
}

// ============= Budget Management =============

model Budget {
  id              String             @id @default(uuid())
  name            String
  description     String?
  
  departmentId    String?
  department      Department?        @relation(fields: [departmentId], references: [id])
  projectId       String?
  project         Project?           @relation(fields: [projectId], references: [id])
  
  fiscalYear      Int
  fiscalPeriod    String             // Q1, Q2, Q3, Q4, or MONTHLY
  
  totalAmount     Decimal            @db.Decimal(15, 2)
  allocatedAmount Decimal            @default(0) @db.Decimal(15, 2)
  spentAmount     Decimal            @default(0) @db.Decimal(15, 2)
  remainingAmount Decimal            @default(0) @db.Decimal(15, 2)
  
  alertThreshold  Decimal            @default(80) @db.Decimal(5, 2) // Percentage
  
  allocations     BudgetAllocation[]
  
  isActive        Boolean            @default(true)
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  @@index([departmentId])
  @@index([projectId])
  @@index([fiscalYear])
}

model BudgetAllocation {
  id              String       @id @default(uuid())
  budgetId        String
  budget          Budget       @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  userId          String?
  user            User?        @relation(fields: [userId], references: [id])
  
  category        String
  amount          Decimal      @db.Decimal(15, 2)
  spentAmount     Decimal      @default(0) @db.Decimal(15, 2)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([budgetId])
  @@index([userId])
}

// ============= Project Management =============

model Project {
  id              String       @id @default(uuid())
  code            String       @unique
  name            String
  description     String?
  
  startDate       DateTime?
  endDate         DateTime?
  
  status          String       @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  
  claims          Claim[]
  budgets         Budget[]
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

// ============= Payroll Integration =============

model PayrollBatch {
  id              String       @id @default(uuid())
  batchNumber     String       @unique
  
  periodStart     DateTime
  periodEnd       DateTime
  
  totalAmount     Decimal      @db.Decimal(15, 2)
  claimCount      Int          @default(0)
  
  claims          Claim[]
  
  status          String       @default("DRAFT") // DRAFT, PROCESSING, COMPLETED, EXPORTED
  
  // Export details
  exportedAt      DateTime?
  exportedBy      String?
  exportFormat    String?      // CSV, XLSX, JSON, API
  exportData      Json?
  
  // Integration
  erpSystem       String?      // JURNAL, ACCURATE, SAP, QUICKBOOKS
  erpBatchId      String?
  erpSyncedAt     DateTime?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([batchNumber])
  @@index([status])
}

// ============= Vendor Integration =============

model VendorIntegration {
  id              String       @id @default(uuid())
  name            String       // GRAB, TRAVELOKA, TOKOPEDIA, etc.
  type            String       // ECOMMERCE, RIDE_HAILING, TRAVEL
  
  apiKey          String?
  apiSecret       String?
  config          Json?
  
  isActive        Boolean      @default(true)
  
  lastSyncAt      DateTime?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model EReceipt {
  id              String       @id @default(uuid())
  vendorId        String
  
  transactionId   String       // Vendor's transaction ID
  transactionDate DateTime
  
  amount          Decimal      @db.Decimal(15, 2)
  currency        String       @default("IDR")
  
  category        String
  description     String?
  
  receiptUrl      String?
  receiptData     Json
  
  // Matching to claims
  isMatched       Boolean      @default(false)
  claimItemId     String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@unique([vendorId, transactionId])
  @@index([transactionDate])
}

// ============= Currency & Exchange Rates =============

model ExchangeRate {
  id              String       @id @default(uuid())
  fromCurrency    String
  toCurrency      String       @default("IDR")
  rate            Decimal      @db.Decimal(15, 6)
  
  effectiveDate   DateTime
  source          String       @default("BI") // Bank Indonesia
  
  createdAt       DateTime     @default(now())
  
  @@unique([fromCurrency, toCurrency, effectiveDate])
  @@index([effectiveDate])
}

// ============= Notifications =============

enum NotificationType {
  CLAIM_SUBMITTED
  CLAIM_APPROVED
  CLAIM_REJECTED
  CLAIM_PAID
  APPROVAL_REQUIRED
  POLICY_VIOLATION
  BUDGET_ALERT
  TRIP_REMINDER
}

enum NotificationChannel {
  EMAIL
  WHATSAPP
  IN_APP
  PUSH
}

model Notification {
  id              String              @id @default(uuid())
  userId          String
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type            NotificationType
  channel         NotificationChannel
  
  title           String
  message         String
  data            Json?
  
  isRead          Boolean             @default(false)
  readAt          DateTime?
  
  sentAt          DateTime?
  
  createdAt       DateTime            @default(now())
  
  @@index([userId])
  @@index([isRead])
}

// ============= Audit Trail =============

model AuditLog {
  id              String       @id @default(uuid())
  userId          String?
  user            User?        @relation(fields: [userId], references: [id])
  
  action          String       // CREATE, UPDATE, DELETE, APPROVE, REJECT, etc.
  entity          String       // CLAIM, USER, APPROVAL, etc.
  entityId        String
  
  changes         Json?        // Before/after values
  ipAddress       String?
  userAgent       String?
  deviceInfo      String?
  
  timestamp       DateTime     @default(now())
  
  @@index([userId])
  @@index([entity, entityId])
  @@index([timestamp])
}
